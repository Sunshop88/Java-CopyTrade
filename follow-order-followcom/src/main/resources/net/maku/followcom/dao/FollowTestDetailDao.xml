<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="net.maku.followcom.dao.FollowTestDetailDao">
    <select id="selectServer" parameterType="net.maku.followcom.query.FollowTestServerQuery" resultType="net.maku.followcom.vo.FollowTestDetailVO">
<!--    SELECT t1.*-->
<!--        FROM follow_test_detail t1-->
<!--        JOIN (-->
<!--        SELECT server_name, platform_type, server_node, MAX(create_time) AS latest_time-->
<!--        FROM follow_test_detail-->
<!--        WHERE deleted = 0-->
<!--        GROUP BY server_name, platform_type, server_node-->
<!--        ) t2 ON t1.server_name = t2.server_name-->
<!--        AND t1.platform_type = t2.platform_type-->
<!--        AND t1.server_node = t2.server_node-->
<!--        AND t1.create_time = t2.latest_time-->
<!--        WHERE  1=1-->
<!--        <if test="query.brokerName != null and query.brokerName != ''">-->
<!--            AND t1.broker_name LIKE CONCAT('%', #{query.brokerName}, '%')-->
<!--        </if>-->
<!--        <if test="query.serverName != null and query.serverName != ''">-->
<!--            AND t1.server_name LIKE CONCAT('%', #{query.serverName}, '%')-->
<!--        </if>-->
<!--        <if test="query.serverNode != null and query.serverNode != ''">-->
<!--            AND t1.server_node LIKE CONCAT('%', #{query.serverNode}, '%')-->
<!--        </if>-->

        SELECT
        <trim suffixOverrides=",">
            t1.*,
            <if test="query.brokerName != null and query.brokerName != ''">
                fp.broker_name,
            </if>
        </trim>
        FROM follow_test_detail t1
        JOIN (
        SELECT server_name, platform_type, COALESCE(server_node, '') AS server_node, MAX(create_time) AS latest_time,vps_id
        FROM follow_test_detail
        WHERE deleted = 0
        GROUP BY server_name, platform_type, COALESCE(server_node, ''),vps_id
        ) t2
        ON t1.server_name = t2.server_name
        AND t1.platform_type = t2.platform_type
        AND COALESCE(t1.server_node, '') = COALESCE(t2.server_node, '')
        AND t1.create_time = t2.latest_time
        AND (t1.vps_id = t2.vps_id OR (t1.vps_id IS NULL AND t2.vps_id IS NULL))
        <if test="query.brokerName != null and query.brokerName != ''">
            LEFT JOIN follow_platform fp ON t1.server_name = fp.server
        </if>
        <where>
            <if test="query.brokerName != null and query.brokerName != ''">
                AND fp.broker_name LIKE CONCAT('%', #{query.brokerName}, '%')
            </if>
            <if test="query.serverName != null and query.serverName != ''">
                AND t1.server_name LIKE CONCAT('%', #{query.serverName}, '%')
            </if>
            <if test="query.serverNode != null and query.serverNode != ''">
                AND COALESCE(t1.server_node, '') LIKE CONCAT('%', #{query.serverNode}, '%')
            </if>
        </where>
    </select>


    <select id="selectServerNode" resultType="net.maku.followcom.vo.FollowTestDetailVO">
        SELECT
            t1.*
        FROM
            follow_test_detail t1
                JOIN (
                SELECT
                    server_name,
                    platform_type,
                    COALESCE(server_node, '') AS server_node,
                    MAX(create_time) AS latest_time,
                    vps_id
                FROM
                    follow_test_detail
                WHERE
                    deleted = 0
                GROUP BY
                    server_name,
                    platform_type,
                    COALESCE(server_node, ''),
                    vps_id
            ) t2 ON t1.server_name = t2.server_name
                AND t1.platform_type = t2.platform_type
                AND COALESCE(t1.server_node, '') = COALESCE(t2.server_node, '')
                AND t1.create_time = t2.latest_time
                AND t1.vps_id = t2.vps_id
        <if test="query.brokerName != null and query.brokerName != ''">
            LEFT JOIN follow_platform fp ON t1.server_name = fp.server
        </if>
        <where>
            <if test="query.serverName != null and query.serverName != ''">
                AND t1.server_name = #{query.serverName}
            </if>
            <if test="query.serverNode != null and query.serverNode != ''">
                AND COALESCE(t1.server_node, '') LIKE CONCAT('%', #{query.serverNode}, '%')
            </if>
        </where>
    </select>
</mapper>
